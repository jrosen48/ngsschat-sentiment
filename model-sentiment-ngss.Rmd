---
title: "#NGSSchat sentiment modeling"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, cache = TRUE)
```

## loading, setting up

```{r}
library(tidyverse)
library(lme4)

d <- read_rds('ngsschat-data-for-modeling.rds')
```

# Descriptive analysis

## overall

```{r}
d %>% count(senti_binary) %>% spread(senti_binary, n) %>% 
  set_names(c("neg", "pos")) %>% mutate(senti_ratio = neg/pos)
```

## by year 

```{r}
d %>% count(year, senti_binary) %>% spread(senti_binary, n) %>% set_names(c("year", "neg", "pos")) %>% mutate(senti_ratio = neg/pos) %>% 
  ggplot(aes(x = year, y = senti_ratio)) +
  geom_point() +
  geom_line() +
  geom_smooth()
```

## by tweet type

```{r}

d %>% count(type_of_tweet, senti_binary) %>% spread(senti_binary, n) %>% set_names(c("type_of_tweet", "neg", "pos")) %>% mutate(senti_ratio = neg/pos)

```

## by state

```{r}
d %>% 
  count(state, senti_binary) %>% 
  spread(senti_binary, n) %>% 
  set_names(c("state", "neg", "pos")) %>% 
  mutate(senti_ratio = neg/pos) %>% 
  arrange(desc(senti_ratio)) %>% 
  ggplot(aes(x = reorder(state, senti_ratio), y = senti_ratio)) +
  geom_col() +
  coord_flip()
```
## by state, by year

```{r}
d %>% 
  filter(year >= 2012) %>% 
  count(state, year, senti_binary) %>% 
  spread(senti_binary, n) %>% 
  set_names(c("state", "year", "neg", "pos")) %>% 
  mutate(senti_ratio = neg/pos) %>% 
  arrange(desc(senti_ratio)) %>% 
  ggplot(aes(x = reorder(state, senti_ratio), y = senti_ratio)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~year)
```

## by adoption status

```{r}
d %>% 
  count(adoption_key, senti_binary) %>% 
  spread(senti_binary, n) %>% 
  set_names(c("adoption_status", "neg", "pos")) %>% 
  mutate(senti_ratio = neg/pos) %>% 
  arrange(desc(senti_ratio))
```

## by adoption status by year

```{r}
d %>% 
  filter(year >= 2012) %>% 
  count(adoption_key, year, senti_binary) %>% 
  spread(senti_binary, n) %>% 
  set_names(c("state", "year", "neg", "pos")) %>% 
  mutate(senti_ratio = neg/pos) %>% 
  arrange(desc(senti_ratio)) %>% 
  ggplot(aes(x = reorder(state, senti_ratio), y = senti_ratio)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~year)
```

# Models

## Just modeling the effect of state

```{r, m0-state}
m0 <- lmer(senti_scale ~ 1 + (1|state), data = d)

sjPlot::tab_model(m0)

performance::icc(m0, by_group = TRUE)
```

## Just modeling the effect of screen_name

```{r, m0-screen_name}
m1 <- lmer(senti_scale ~ 1 + (1|screen_name), data = d)

sjPlot::tab_model(m1)

performance::icc(m1, by_group = TRUE)
```

## Both state and screen name 

```{r, m1}
m2 <- lmer(senti_scale ~ 1 + (1|state) + (1|screen_name), data = d)

sjPlot::tab_model(m2)

performance::icc(m2, by_group = TRUE)
```

## Adding whether the tweets incuded ngsschat or not

```{r, m1-chat-all-tweets}
m4 <- lmer(senti_scale ~ 1 + type_of_tweet + (1|state) + (1|screen_name), data = d)

sjPlot::tab_model(m4, show.icc = TRUE)

performance::icc(m4, by_group = TRUE)
```

## Adding year as a factor

```{r, m2}
m5 <- lmer(senti_scale ~ 1 + type_of_tweet + year_fct + (1|state) + (1|screen_name), data = d)

sjPlot::tab_model(m5, show.icc = TRUE)

performance::icc(m5, by_group = TRUE)
```

## Adding year (scaled) as a slope

```{r, m2-slope}
m6 <- lmer(senti_scale ~ 1 + type_of_tweet + scale(year, scale = FALSE) + (1|state) + (1|screen_name), data = d)

sjPlot::tab_model(m6, show.icc = TRUE)

performance::icc(m6, by_group = TRUE)
```

## Adding year as a random effect

```{r, m2-re}
m7 <- lmer(senti_scale~ 1 + type_of_tweet + (1|year) + (1|state) + (1|screen_name), data = d)

sjPlot::tab_model(m7, show.icc = TRUE)

performance::icc(m7, by_group = TRUE)
```

## Adding adoption status

```{r, m3-lmer-run}
m8 <- lmer(senti_scale ~ -1 + type_of_tweet + year_centered + adoption_key + lead + modified + time_on_twitter + (1|state) + (1|screen_name), data = d)

sjPlot::plot_model(m8) + hrbrthemes::theme_ipsum()

performance::icc(m8, by_group = TRUE)

sjPlot::tab_model(m8, show.icc = TRUE, show.se = TRUE, file = 'out1.doc')
```

## Adding others state-level vars

```{r, m3-lmer-add}
m10 <- lmer(senti_scale ~ 1 + scale(year, scale = FALSE) + lead + modified + type_of_tweet + (1|state) + (1|screen_name), data = d)

sjPlot::tab_model(m10, show.icc = TRUE)

performance::icc(m10, by_group = TRUE)
```

## ignoring state because of missing data

```{r, m3-lmer-add-no-state}
m11 <- lmer(senti_scale ~ 1 + scale(year, scale = FALSE) + type_of_tweet + (1|screen_name), data = d)

sjPlot::tab_model(m11, show.icc = TRUE)

performance::icc(m11, by_group = TRUE)
```

## ignoring screen name to understand potential bias from not doing so

```{r, m3-lm}
m12 <- lm(senti_scale ~ 1 + scale(year, scale = FALSE) + type_of_tweet, data = d)

sjPlot::tab_model(m12, show.icc = TRUE)
```
